name: Dependencies Autoupdate

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Run auto dependency update
        uses: romoh/dependencies-autoupdate@v1.3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr-branch: develop
          update-command: >-
            'npm update && if git diff --name-only --exit-code package.json; then
            echo "No package.json changes; reverting updates."; git checkout -- .;
            else :; fi'

      - name: Request reviewers
        if: ${{ vars.AUTO_UPDATE_REVIEWERS != '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REVIEWERS: ${{ vars.AUTO_UPDATE_REVIEWERS }}
        run: |
          set -euo pipefail

          reviewers_csv=$(printf '%s' "$REVIEWERS" | tr -d '[:space:]')
          if [ -z "$reviewers_csv" ]; then
            echo "No reviewers configured."
            exit 0
          fi

          pr_number=$(gh api "repos/${{ github.repository }}/pulls?head=${{ github.repository_owner }}:automated-dependencies-update&base=develop&state=open" --jq '.[0].number')
          if [ -z "$pr_number" ]; then
            echo "No open dependency update PR found."
            exit 0
          fi

          reviewers_json=$(printf '%s' "$reviewers_csv" | jq -R 'split(",") | map(select(length > 0))')
          if [ "$(printf '%s' "$reviewers_json" | jq 'length')" -eq 0 ]; then
            echo "No valid reviewers after parsing."
            exit 0
          fi

          already_requested=$(gh api "repos/${{ github.repository }}/pulls/$pr_number" --jq '[.requested_reviewers[].login]')
          missing=$(jq -n --argjson desired "$reviewers_json" --argjson existing "$already_requested" '$desired - $existing')
          if [ "$(printf '%s' "$missing" | jq 'length')" -eq 0 ]; then
            echo "Reviewers already requested."
            exit 0
          fi

          echo "Requesting reviewers for PR #$pr_number: $(printf '%s' "$missing" | jq -r '. | join(", ")')"
          gh api -X POST "repos/${{ github.repository }}/pulls/$pr_number/requested_reviewers" \
            --input <(jq -n --argjson reviewers "$missing" '{reviewers: $reviewers}')
